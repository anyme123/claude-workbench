# 智能路由 (Smart Routing) 功能深度分析与优化方案

本文档对 Claude Workbench 中集成的智能路由功能进行了深度分析，并结合其核心依赖 `claude-code-router` 提出了详细的改进优化方案和使用说明。

---

## 1. 现有功能深度分析

### 1.1. 整体架构

项目采用了一种清晰的 **主控-代理 (Controller-Proxy)** 架构：

*   **主控 (Controller)**: Tauri 的 Rust 后端作为主控，负责管理外部 `claude-code-router` (ccr) Node.js 进程的生命周期（启动、停止、监控），并为其提供配置文件。
*   **代理 (Proxy)**: Rust 后端不直接处理路由逻辑，而是通过一个 HTTP 客户端 (`RouterProxyClient`) 将请求代理给 `ccr` 服务。
*   **前端 (Frontend)**: 基于 React 和 `useRouter` Hook 的仪表盘，为用户提供了全面的图形化管理界面。

**请求流程**:
`UI -> Tauri 命令 -> RouterProxyClient -> ccr 服务 -> 真实 AI 提供商 -> ccr 服务 -> Tauri -> UI`

### 1.2. 核心代码分析

*   **配置管理 (`src-tauri/src/router/config.rs`)**: `IntegratedConfig` 结构统一管理了所有相关设置，特别是 `RoutingRules` 和 `RoutingMode`。`ConfigManager` 能够将主应用的提供商设置同步到 Router 的配置中，是一个非常实用的集成功能。
*   **进程管理 (`src-tauri/src/router/manager.rs`)**: 使用 `ccr start/stop/status` 等命令行工具来管理路由服务，这是一个松耦合且可靠的设计。
*   **前端 (`src/components/RouterDashboard.tsx` & `src/hooks/useRouter.ts`)**: `useRouter` Hook 封装了所有后端通信、状态管理、错误处理和轮询逻辑，为 UI 组件提供了极其简洁和强大的接口。UI 仪表盘功能全面，用户体验良好。

### 1.3. 结论

当前的集成方案设计良好、功能完整、代码健壮。它成功地将 `claude-code-router` 的能力无缝集成到了 Claude Workbench 中，为用户提供了强大的多模型调度能力。

---

## 2. 详细的改进优化方案

基于对现有代码和 `claude-code-router` 的深度理解，提出以下优化建议：

### 2.1. 配置管理的统一与简化 (核心优化)

*   **问题**: 目前存在两套配置逻辑。一套由本应用管理 (`IntegratedConfig`)，另一套是 `ccr` 内部的 `config.json`。应用虽会同步配置，但又通过 API 回读配置，造成了数据流的冗余和潜在的不一致性。
*   **优化方案**: **确立单一事实来源 (Single Source of Truth)。**
    1.  **取消回读**: 移除所有直接从 `ccr` API (`/api/config`) 读取配置的函数。
    2.  **中心化配置**: 所有与路由相关的配置都应通过本应用的 `RouterDashboard` UI 进行修改，并由 `ConfigManager` 统一管理。
    3.  **单向同步**: 数据流应始终是单向的：`本应用 -> ccr`。`ConfigManager` 负责在启动或配置变更时，动态生成 `ccr` 所需的配置文件。
    4.  **前端数据源**: 前端 `useRouter` hook 的所有数据（如可用模型）都应直接从 Tauri 后端的 `ConfigManager` 获取。
*   **收益**: 架构更清晰、配置更可靠、维护更简单。

### 2.2. 路由规则的动态化与高级化

*   **问题**: 当前的路由规则是基于固定的几种任务类型 (`default`, `think` 等)，不够灵活。
*   **优化方案**:
    1.  **动态规则**: 将 `RoutingRules` 修改为可动态增删的结构，允许用户创建自定义规则。
    2.  **规则定义**: 每条规则应包含 `name` (规则名)、`keywords` (触发关键词数组) 和 `model` (目标模型)。
    3.  **UI 支持**: 在 `RouterDashboard` 中增加一个“路由规则”管理界面，允许用户增删改规则。
    4.  **智能匹配**: 增强路由逻辑，使其能够根据用户 prompt 中的关键词来匹配这些动态规则。
*   **收益**: 提供高度定制化的路由能力，实现基于 prompt 内容的真正“智能”路由。

### 2.3. 模型能力的自动发现与同步

*   **问题**: 当前在同步提供商配置时，其支持的 `models` 列表是缺失的。
*   **优化方案**:
    1.  **增加模型发现命令**: 创建一个新的 Tauri 命令，例如 `router_discover_provider_models`，该命令根据提供商的配置，向其 `/v1/models` 端点发起请求，获取模型列表。
    2.  **自动调用**: 在同步配置或用户编辑提供商时，自动调用此命令来填充模型列表。
    3.  **UI 集成**: 在提供商配置界面，添加一个“刷新模型列表”的按钮。
*   **收益**: 模型列表保持实时、准确，减少用户手动配置的出错率。

### 2.4. 统一化模型切换机制

*   **问题**: 存在两种模型切换方式，一种是生成 `/model` 命令字符串，另一种是直接 API 调用，造成了逻辑混乱。
*   **优化方案**:
    1.  **废弃字符串命令**: 彻底移除生成命令字符串的方式及其前端依赖。
    2.  **统一使用 API 调用**: 所有模型切换操作都统一使用 `router_switch_model` 命令，通过 API 与 `ccr` 通信。
*   **收益**: 实现前后端解耦，提高模型切换的可靠性。

---

## 3. 智能路由功能使用说明

### 3.1. 功能简介

智能路由功能允许您将工作流中的不同任务自动、智能地分配给最适合、最经济的 AI 模型。它通过一个内置的代理服务器拦截 Claude CLI 的请求，并根据您定义的规则将其转发到不同的模型提供商（如 OpenAI, Google, Deepseek 等）。

### 3.2. 快速上手

1.  **打开仪表盘**: 在主应用中找到并点击“智能路由”或“Router Dashboard”。
2.  **同步提供商**: 在**控制面板**中，点击 **与 Workbench 同步配置**。
3.  **启动路由服务**: 点击 **启动** 按钮，等待状态变为“正常”。
4.  **选择路由模式**: 在**路由模式**下拉菜单中，选择 **智能路由**。
5.  **开始使用**: 正常使用 Claude CLI，您的请求将根据规则被自动路由。

### 3.3. 核心功能详解

*   **控制面板 (Control Panel)**:
    *   **进程控制**: 启动、停止或重启路由服务。
    *   **路由模式**:
        *   **智能路由**: 根据预设规则自动选择模型。
        *   **原生 Claude CLI**: 临时禁用路由，直连 Claude。
        *   **仅使用 Router**: 强制所有请求都通过路由处理。
        *   **手动选择**: 强制所有请求到手动选择的特定模型。
    *   **配置同步**: 同步主应用中的提供商配置。

*   **模型切换 (Model Switcher)**:
    *   手动选择一个提供商和模型，点击“切换模型”后，路由模式将自动变为“手动选择”。
    *   要恢复自动路由，请在“控制面板”将模式改回“智能路由”。

*   **Web 管理 (Web UI)**:
    *   内嵌了 `claude-code-router` 的原生 Web 管理界面，用于高级用户调试。

*   **统计监控 (Stats)**:
    *   提供请求、成本和性能的统计信息。

*   **配置管理 (Config)**:
    *   用于微调底层参数，通常无需修改。
