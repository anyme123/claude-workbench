# 会话记录导出功能

## 功能概述

为 Claude Workbench 实现了完整的会话记录导出功能，参考 opcode 项目的实现方案并进行优化增强。

## 功能特点

### 1. 多种导出格式

- **JSON**: 结构化数据格式，包含完整的会话元数据和消息列表
- **JSONL**: 每行一个 JSON 对象，便于流式处理和增量解析
- **Markdown**: 人类可读的格式，适合阅读和分享

### 2. 统一操作入口

- **单一按钮**: 合并了导出和复制功能到一个统一的"导出"按钮
- **分类菜单**: 下拉菜单分为"复制到剪贴板"和"保存到文件"两个部分
- **每个选项都有说明**: 清晰的子标题说明每种格式的用途

### 3. 完整的导出内容

导出的内容包含完整的会话信息：
- **思考过程**: 包含 AI 的完整思考块（thinking blocks）内容
- **工具调用**: 完整的工具使用记录和参数
- **工具结果**: 工具执行的返回结果
- **所有消息类型**: 支持导出所有类型的消息块
- **会话元数据**: 会话 ID、项目路径、模型、创建时间等

### 4. 用户友好的保存方式

- **文件选择对话框**: 使用 Tauri 原生对话框，用户可以自主选择保存路径和文件名
- **智能文件过滤**: 根据导出格式自动设置文件扩展名过滤器
- **实时状态反馈**: 保存成功/失败都会有清晰的提示

### 5. UI 集成

导出按钮集成在 FloatingPromptInput 组件的控制栏中，与其他会话控制功能（模型选择、思考模式等）保持一致的设计风格。

## 实现文件

### 核心模块

1. **src/lib/sessionExport.ts**
   - 导出格式转换函数
   - 文件下载功能
   - 剪贴板复制功能
   - 文件名生成规则

2. **src/components/SessionToolbar.tsx**
   - 导出工具栏 UI 组件
   - 下拉菜单集成
   - 状态管理和反馈

### 集成点

1. **src/components/FloatingPromptInput/index.tsx**
   - 在控制栏中集成 SessionToolbar
   - 传递消息列表和会话信息

2. **src/components/FloatingPromptInput/types.ts**
   - 添加 `session` 属性支持

3. **src/components/ClaudeCodeSession.tsx**
   - 传递完整会话信息到 FloatingPromptInput

## 使用方法

### 统一的导出操作

1. 在会话中点击"导出"按钮（FileDown 图标）
2. 在下拉菜单中选择操作类型：

#### 复制到剪贴板
   - **复制为 JSONL**: 原始消息数据 - 适合程序处理
   - **复制为 JSON**: 结构化数据 - 包含完整元数据
   - **复制为 Markdown**: 可读格式 - 适合分享和阅读

#### 保存到文件
   - **保存为 JSON**: 完整会话数据 - 选择保存位置和文件名
   - **保存为 JSONL**: 流式数据格式 - 便于增量处理
   - **保存为 Markdown**: 人类可读文档 - 生成精美的文档

3. 操作完成后会显示状态提示：
   - ✅ "已复制为 XXX" 或 "文件已保存"
   - ❌ "复制失败" 或 "保存失败"

## 导出文件格式说明

### JSON 格式示例

```json
{
  "version": 1,
  "exported_at": "2025-11-18T15:30:00.000Z",
  "session": {
    "id": "abc123def",
    "project_id": "project-001",
    "project_path": "/path/to/project",
    "created_at": 1700318400,
    "model": "claude-sonnet-4-5-20250929"
  },
  "messages": [
    {
      "type": "user",
      "message": { "content": "..." },
      "sentAt": "2025-11-18T15:30:00.000Z"
    },
    {
      "type": "assistant",
      "message": { "content": [...] },
      "receivedAt": "2025-11-18T15:30:05.000Z"
    }
  ],
  "message_count": 10
}
```

### JSONL 格式示例

```jsonl
{"type":"user","message":{"content":"..."},"sentAt":"2025-11-18T15:30:00.000Z"}
{"type":"assistant","message":{"content":[...]},"receivedAt":"2025-11-18T15:30:05.000Z"}
```

### Markdown 格式示例

```markdown
# Claude 会话记录

## 会话信息

- **会话 ID**: abc123def
- **项目路径**: /path/to/project
- **模型**: claude-sonnet-4-5-20250929
- **创建时间**: 2025-11-18 15:30:00

---

## 对话内容

### 👤 用户

如何实现一个二叉树？

---

### 🤖 Assistant

**💭 思考过程:**

```
用户想要实现一个二叉树。我需要考虑：
1. 节点的数据结构
2. 插入操作
3. 遍历方法
...
```

我来帮你实现一个二叉树...

**🔧 工具调用: Write**

```json
{
  "path": "tree.py",
  "content": "class TreeNode:\n    def __init__(self, val):\n        self.val = val\n        ..."
}
```

**📋 工具结果**

```
File written successfully
```

---

## 统计信息

- 用户消息: 5
- AI 回复: 5
- 总消息数: 10

*导出时间: 2025-11-18 15:35:00*
```

## 文件命名规则

导出的文件名格式为：`claude-session-{session_id前8位}-{日期}.{扩展名}`

例如：
- `claude-session-abc123de-2025-11-18.json`
- `claude-session-abc123de-2025-11-18.jsonl`
- `claude-session-abc123de-2025-11-18.md`

## 技术特点

### 数据完整性

- **思考过程**: 完整导出 AI 的 thinking blocks 内容
- **工具记录**: 包含工具调用参数和执行结果
- **元数据**: 保留完整的会话元数据（ID、路径、模型、时间等）
- **所有消息类型**: 支持用户、助手、工具调用、工具结果等所有类型
- **未知类型兜底**: 即使遇到未知的消息类型也会导出原始 JSON

### 用户体验

- **统一操作入口**: 单个按钮整合复制和保存功能
- **清晰的选项说明**: 每个选项都有副标题说明用途
- **实时状态反馈**: 成功/失败都有 2 秒的状态提示
- **原生文件对话框**: 使用 Tauri 原生对话框，用户体验更好
- **智能禁用**: 无消息或正在流式输出时自动禁用
- **统一的设计风格**: 与其他控制按钮保持一致

### 技术实现

- **Tauri 集成**: 使用 `@tauri-apps/plugin-dialog` 和 `@tauri-apps/plugin-fs`
- **异步处理**: 支持异步保存操作，不阻塞 UI
- **错误处理**: 完善的错误捕获和用户提示
- **类型安全**: 完整的 TypeScript 类型定义
- **剪贴板兼容**: 支持现代浏览器的剪贴板 API

## 参考项目对比

### opcode 项目实现

- **位置**: SessionHeader 组件中的 Popover
- **按钮**: 分离的"复制"和"导出"按钮
- **格式**: JSONL 和 Markdown
- **保存**: 复制到剪贴板
- **内容**: 基础消息内容

### 当前项目优化

- **位置**: FloatingPromptInput 控制栏
- **按钮**: 统一的"导出"按钮，分类菜单
- **格式**: JSON、JSONL 和 Markdown（3 种）
- **保存**: 复制到剪贴板 + Tauri 原生文件对话框
- **内容**: 完整内容包括思考过程、工具调用、所有消息类型
- **交互**: 实时状态反馈，用户体验更好

## 优化历史

### v1.0 - 初始实现
- 基础的复制和导出功能
- 分离的两个按钮

### v2.0 - 优化增强
- ✅ 合并导出和复制按钮为统一入口
- ✅ 补充完整的导出内容（思考过程、工具调用、所有消息类型）
- ✅ 使用 Tauri 原生文件选择对话框
- ✅ 改进状态反馈和用户体验
- ✅ 优化菜单布局和选项说明

## 未来扩展

可能的功能扩展方向：

1. **批量导出**: 支持一次导出多个会话
2. **自定义格式**: 支持用户自定义导出模板
3. **云端同步**: 将会话记录同步到云端
4. **分享功能**: 生成可分享的会话链接
5. **导入功能**: 支持导入之前导出的会话记录
6. **选择性导出**: 支持选择导出部分消息
7. **HTML 格式**: 支持导出为独立的 HTML 文件

## 测试建议

1. **基础功能测试**
   - 复制 JSONL 格式
   - 复制 Markdown 格式
   - 导出 JSON 文件
   - 导出 JSONL 文件
   - 导出 Markdown 文件

2. **边界情况测试**
   - 空会话（无消息）
   - 正在流式输出时
   - 包含图片的消息
   - 包含工具调用的消息
   - 非常长的会话

3. **兼容性测试**
   - 不同浏览器（Chrome, Firefox, Edge）
   - 不同操作系统（Windows, macOS, Linux）
   - 剪贴板权限受限的情况

## 维护说明

- 导出格式版本号当前为 `1`，如有重大格式变更应递增版本号
- 文件名规则应保持一致性，便于用户管理导出的文件
- UI 反馈应及时清晰，避免用户重复操作
