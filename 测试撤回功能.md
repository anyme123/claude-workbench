# 撤回功能测试指南

## 启动应用（带调试日志）

```cmd
start-with-debug.bat
```

或

```powershell
$env:RUST_LOG="debug"
npm run tauri dev
```

---

## 测试步骤

### 1. 清理旧数据（重要！）

```powershell
# 清理测试项目的文件
cd C:\Users\Administrator\Desktop\新建文件夹
Remove-Item *.txt -Force -ErrorAction SilentlyContinue

# 清理旧的会话记录（可选）
cd C:\Users\Administrator\.claude\projects\C--Users-Administrator-Desktop------
Remove-Item *.jsonl, *.prompts.json -Force -ErrorAction SilentlyContinue
```

### 2. 发送第一个提示词

- 输入："创建1.txt"
- 发送
- 等待完成

**查看后端日志**：
```
[INFO] Recording prompt sent for session: xxx
[INFO] Recorded prompt #0 with git_commit_before: xxx
[INFO] Marking prompt #0 completed
[INFO] Auto-committed changes after prompt #0
[INFO] Updated prompt #0 git_commit_after to xxx
```

### 3. 发送第二个提示词

- 输入："创建2.txt"
- 发送
- 等待完成

**查看后端日志**：
```
[INFO] Recording prompt sent for session: xxx
[INFO] Current git commit: yyy (应该与 prompt #0 的 git_commit_after 相同)
[INFO] Recorded prompt #1 with git_commit_before: yyy
[INFO] Auto-committed changes after prompt #1
```

### 4. 验证 Git 历史

```powershell
cd C:\Users\Administrator\Desktop\新建文件夹
git log --oneline
```

**应该看到 3 个 commit**：
```
xxx [Claude Code] After prompt #1
yyy [Claude Code] After prompt #0
zzz [Claude Workbench] Initial commit
```

### 5. 测试撤回

- 点击第二个提示词的撤回按钮
- 确认撤回操作

**查看后端日志**：
```
[INFO] Reverting to prompt #1
[INFO] Resetting repository to commit: yyy
[DEBUG] Line 0-N: 扫描消息
[INFO] [OK] Found real user message at line X
[INFO] [TARGET] Target prompt #1 found at line X
[INFO] Truncated main session: kept X lines
```

### 6. 验证结果

```powershell
# 检查文件
ls *.txt
# 应该只有 1.txt

# 检查 Git 状态
git log --oneline
# 应该回到 prompt #0 之后的状态
```

---

## 关键日志解读

### 提示词记录成功

```
[INFO] Recorded prompt #N with git_commit_before: XXX
```

### Git 自动提交成功

```
[INFO] Auto-committed changes after prompt #N
```

### 撤回成功

```
[INFO] [TARGET] Target prompt #N found at line X
[INFO] Truncated main session: kept X lines
```

---

## 常见问题

### Q: 没有看到自动提交日志

**检查**：
1. 提示词是否有修改文件？
2. 是否看到 `[DEBUG] No changes to commit`？

**说明**：如果提示词没有修改文件（如只是查询），不会创建新 commit，这是正常的。

### Q: Git 历史没有新 commit

**原因**：提示词没有导致文件更改（如激活子代理、查询信息等）

### Q: 撤回失败

**检查后端日志**：
1. 是否找到了目标 prompt？
2. 是否有解析错误？
3. JSONL 文件是否损坏？

---

## 文件位置

### JSONL 文件
```
C:\Users\Administrator\.claude\projects\{project_id}\{session_id}.jsonl
```

### 提示词记录
```
C:\Users\Administrator\.claude\projects\{project_id}\{session_id}.prompts.json
```

### Agent 文件
```
C:\Users\Administrator\.claude\projects\{project_id}\agent-*.jsonl
```

---

## 完整修复说明

详见 `REVERT_FEATURE_FIX.md`

